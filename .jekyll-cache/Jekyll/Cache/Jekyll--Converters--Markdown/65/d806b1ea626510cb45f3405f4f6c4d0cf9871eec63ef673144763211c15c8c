I"˜^<script src="https://code.highcharts.com/highcharts.js"></script>

<script src="https://code.highcharts.com/highcharts-more.js"></script>

<script type="text/javascript" src="/js/laf1.js"></script>

<h1 id="interactive-visualization-of-allelic-expression-patterns-in-single-cell-rna-seq-data">Interactive visualization of allelic expression patterns in single-cell RNA-seq data</h1>

<p>I recently developed <a href="http://jef.works/HoneyBADGER/">an R package called <code class="highlighter-rouge">HoneyBADGER</code></a> that infers copy number alteration and loss-of-heterozygocity events in single cells based on persistent allelic imbalance in single-cell RNA-sequencing data. Intuitively, if a cell has a copy number alteration such as a deletion of a particular chromosomal region, then, within this region, we should only observe expression from the non-deleted allele. In contrast, in a neutral diploid region, we should be able to detect expression from both alleles.</p>

<p>Visualizing the patterns of allelic expression for heterozygous SNPs within a deletion or neutral region can really drive home this point. We can use the <code class="highlighter-rouge">HoneyBADGER</code> package to plot such lesser-allele fraction (LAF) profiles for heterozygous SNPs in 75 single cells from a glioblastoma cancer patient where we expect a subpopulation of cells to harbor a Chromosome 10 deletion.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">HoneyBADGER</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get data</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="c1">## alternate allele</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">cov.sc</span><span class="p">)</span><span class="w"> </span><span class="c1">## total coverage</span><span class="w">
</span><span class="c1"># Set the allele matrices</span><span class="w">
</span><span class="n">allele.mats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setAlleleMats</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">cov.sc</span><span class="p">)</span><span class="w">
</span><span class="c1"># Map snps to genes</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">TxDb.Hsapiens.UCSC.hg19.knownGene</span><span class="p">)</span><span class="w">
</span><span class="n">geneFactor</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setGeneFactors</span><span class="p">(</span><span class="n">allele.mats</span><span class="o">$</span><span class="n">snps</span><span class="p">,</span><span class="w">
    </span><span class="n">TxDb.Hsapiens.UCSC.hg19.knownGene</span><span class="p">)</span><span class="w">
</span><span class="c1"># Plot static version</span><span class="w">
</span><span class="n">r.maf</span><span class="o">=</span><span class="n">allele.mats</span><span class="o">$</span><span class="n">r.maf</span><span class="w">
</span><span class="n">n.sc</span><span class="o">=</span><span class="n">allele.mats</span><span class="o">$</span><span class="n">n.sc</span><span class="w">
</span><span class="n">l.maf</span><span class="o">=</span><span class="n">allele.mats</span><span class="o">$</span><span class="n">l.maf</span><span class="w">
</span><span class="n">n.bulk</span><span class="o">=</span><span class="n">allele.mats</span><span class="o">$</span><span class="n">n.bulk</span><span class="w">
</span><span class="n">snps</span><span class="o">=</span><span class="n">allele.mats</span><span class="o">$</span><span class="n">snps</span><span class="w">
</span><span class="n">region</span><span class="o">=</span><span class="n">GRanges</span><span class="p">(</span><span class="n">seqname</span><span class="o">=</span><span class="s1">'chr10'</span><span class="p">,</span><span class="w"> </span><span class="n">IRanges</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">=</span><span class="m">1e9</span><span class="p">))</span><span class="w">
</span><span class="n">plotAlleleProfile</span><span class="p">(</span><span class="n">r.maf</span><span class="p">,</span><span class="w"> </span><span class="n">n.sc</span><span class="p">,</span><span class="w"> </span><span class="n">l.maf</span><span class="p">,</span><span class="w"> </span><span class="n">n.bulk</span><span class="p">,</span><span class="w"> </span><span class="n">snps</span><span class="p">,</span><span class="w"> </span><span class="n">region</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/assets/blog/laf1.png" class="img-responsive" />
<img src="/assets/blog/laf2.png" class="img-responsive" /></p>

<p>Each point here represents a heterozygous SNP (column) in a cell (row). The top row corresponds to the composite of all single cells. Coverage is reflected in the dot size and allelic bias in color. Yellow indicates equal expression of both alleles, while blue indicates only expression of the lesser allele and red only expression of the major allele.</p>

<p>Visually, we can see how on Chromosome 10, in a subset of cells, there is persistent expression from one allele. In contrast, in a neutral diploid region such as Chromosome 3, we are able to see expression of both alleles.</p>

<p>However, this plot is static and difficult to explore. Itâ€™s difficult to say which SNPs in which cells specifically are coming from the non-deleted allele and how many reads are at each SNP without going back into R and tediously looking through a data matrix. Inspired by the <a href="https://www.gtexportal.org/home/bubbleHeatmapPage/ACTN3">GTEx eQLT visualizer</a> and applying what Iâ€™ve blogged about previously on <a href="http://jef.works/blog/2018/02/10/interactive-visualizations-with-highcharter/">interactive visualizations with highcharter</a>, I sought to make an interactive version of these LAF profiles.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make interactive plot with highcharter</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">highcharter</span><span class="p">)</span><span class="w">
</span><span class="c1"># restrict SNPs to region</span><span class="w">
</span><span class="n">overlap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">IRanges</span><span class="o">::</span><span class="n">findOverlaps</span><span class="p">(</span><span class="n">region</span><span class="p">,</span><span class="w"> </span><span class="n">snps</span><span class="p">)</span><span class="w">
</span><span class="n">hit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">snps</span><span class="p">))</span><span class="w">
</span><span class="n">hit</span><span class="p">[</span><span class="n">S4Vectors</span><span class="o">::</span><span class="n">subjectHits</span><span class="p">(</span><span class="n">overlap</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">TRUE</span><span class="w">
</span><span class="n">vi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">hit</span><span class="w">
</span><span class="n">r.maf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.maf</span><span class="p">[</span><span class="n">vi</span><span class="p">,]</span><span class="w">
</span><span class="n">n.sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">n.sc</span><span class="p">[</span><span class="n">vi</span><span class="p">,]</span><span class="w">
</span><span class="n">l.maf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">l.maf</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span><span class="w">
</span><span class="n">n.bulk</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">n.bulk</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span><span class="w">
</span><span class="n">snps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">snps</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span><span class="w">
</span><span class="n">chrs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">region</span><span class="o">@</span><span class="n">seqnames</span><span class="o">@</span><span class="n">values</span><span class="w">
</span><span class="c1"># order snps</span><span class="w">
</span><span class="n">mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.maf</span><span class="o">/</span><span class="n">n.sc</span><span class="w">
</span><span class="n">tl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tapply</span><span class="p">(</span><span class="nf">seq_along</span><span class="p">(</span><span class="n">snps</span><span class="p">),</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">snps</span><span class="o">@</span><span class="n">seqnames</span><span class="p">)),</span><span class="k">function</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="n">mat</span><span class="p">[</span><span class="nf">names</span><span class="p">(</span><span class="n">snps</span><span class="p">)[</span><span class="n">ii</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">snps</span><span class="o">@</span><span class="n">ranges</span><span class="o">@</span><span class="n">start</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">decreasing</span><span class="o">=</span><span class="nb">F</span><span class="p">)]],,</span><span class="n">drop</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">]</span><span class="w">
</span><span class="p">})</span><span class="w">
</span><span class="n">tl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tl</span><span class="p">[</span><span class="n">chrs</span><span class="p">]</span><span class="w">
</span><span class="c1"># reshape into data frame</span><span class="w">
</span><span class="n">r.tot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">r.maf</span><span class="o">/</span><span class="n">n.sc</span><span class="p">,</span><span class="w"> </span><span class="s1">'Bulk'</span><span class="o">=</span><span class="n">l.maf</span><span class="o">/</span><span class="n">n.bulk</span><span class="p">)</span><span class="w">
</span><span class="n">n.tot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">n.sc</span><span class="p">,</span><span class="w"> </span><span class="s1">'Bulk'</span><span class="o">=</span><span class="n">n.bulk</span><span class="p">)</span><span class="w">
</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">reshape2</span><span class="o">::</span><span class="n">melt</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">r.tot</span><span class="p">))</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'cell'</span><span class="p">,</span><span class="w"> </span><span class="s1">'snp'</span><span class="p">,</span><span class="w"> </span><span class="s1">'alt.frac'</span><span class="p">)</span><span class="w">
</span><span class="n">rownames</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">m</span><span class="o">$</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">$</span><span class="n">snp</span><span class="p">)</span><span class="w">
</span><span class="n">m</span><span class="o">$</span><span class="n">alt.frac</span><span class="p">[</span><span class="nf">is.nan</span><span class="p">(</span><span class="n">m</span><span class="o">$</span><span class="n">alt.frac</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">reshape2</span><span class="o">::</span><span class="n">melt</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">n.tot</span><span class="p">))</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'cell'</span><span class="p">,</span><span class="w"> </span><span class="s1">'snp'</span><span class="p">,</span><span class="w"> </span><span class="s1">'coverage'</span><span class="p">)</span><span class="w">
</span><span class="n">rownames</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">n</span><span class="o">$</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">$</span><span class="n">snp</span><span class="p">)</span><span class="w">
</span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">coverage</span><span class="o">=</span><span class="n">n</span><span class="o">$</span><span class="n">coverage</span><span class="p">)</span><span class="w">
</span><span class="c1"># convert categorical data to numeric</span><span class="w">
</span><span class="c1"># numbers to colors</span><span class="w">
</span><span class="c1"># for highcharter plotting</span><span class="w">
</span><span class="n">dat</span><span class="o">$</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.factor</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">snp</span><span class="p">))</span><span class="w">
</span><span class="n">dat</span><span class="o">$</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.factor</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">cell</span><span class="p">))</span><span class="w">
</span><span class="n">colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dat</span><span class="o">$</span><span class="n">alt.frac</span><span class="w">
</span><span class="n">colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colors</span><span class="o">/</span><span class="nf">max</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">gradientPalette</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"turquoise"</span><span class="p">,</span><span class="w"> </span><span class="s2">"yellow"</span><span class="p">,</span><span class="w"> </span><span class="s2">"red"</span><span class="p">),</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Lab"</span><span class="p">)(</span><span class="m">1024</span><span class="p">)</span><span class="w">
</span><span class="n">cols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gradientPalette</span><span class="p">[</span><span class="n">colors</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">gradientPalette</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">cols</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'#eeeeee'</span><span class="w">
</span><span class="n">dat</span><span class="o">$</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span><span class="w">

</span><span class="c1"># plot as interactive scatter/bubble plot using highcharter</span><span class="w">
</span><span class="n">hc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hchart</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"scatter"</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcaes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w">
	</span><span class="n">z</span><span class="o">=</span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="w">
	</span><span class="n">af</span><span class="o">=</span><span class="n">alt.frac</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">snp</span><span class="o">=</span><span class="n">snp</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">hc_plotOptions</span><span class="p">(</span><span class="n">bubble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">minSize</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">maxSize</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">hc_title</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Scatter chart with size and color"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">hc_title</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s1">'HoneyBADGER LAF Profile for '</span><span class="p">,</span><span class="w"> </span><span class="n">chr</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">hc_tooltip</span><span class="p">(</span><span class="n">headerFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">pointFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;b&gt;cell&lt;/b&gt;: {point.name} &lt;br&gt;
	&lt;b&gt;snp&lt;/b&gt;: {point.snp} &lt;br&gt;
	&lt;b&gt;alt frac&lt;/b&gt;: {point.af}
	&lt;br&gt; &lt;b&gt;cov&lt;/b&gt;: {point.z}"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">hc_xAxis</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">hc_yAxis</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1">## export as laf1.js</span><span class="w">
</span><span class="n">export_hc</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">'laf1'</span><span class="p">,</span><span class="w"> </span><span class="n">hc</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>I then can take the exported <code class="highlighter-rouge">laf1.js</code> and include it in this blog post (you can view the page source to see for yourself) to generate the interactive plot below.</p>

<h2 id="result">Result</h2>

<div align="center"><span id="laf1"></span></div>

<p>Now, we can easily hover over a particular dot and see which SNP it corresponds to in which cells and exactly how many reads were at this SNP site. We can even add in more information on each SNP into the tooltip like what gene itâ€™s in or its known rsIDs. Who knows? Use your imagination. Try it out for yourself with a different chromosome or apply to your own data.</p>

<p><strong>Warning!</strong>
Each SNP in each cell is rendered as an SVG. Generating such an interactive plot for a large number of cells or a large number of SNPs may crash your browser.</p>

:ET