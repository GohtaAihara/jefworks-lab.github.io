I"i`<p>Over a billion people worldwide purchase goods online. Global e-retail sales are in the trillions of dollars. So given all this interest in online shopping, you’d think that it would be easier - specifically, easier to browse. I find browsing in online shopping very limited. Particularly when it comes to sorting or filtering products. Have you ever noticed when shopping online how you can sort by ‘customer rating’ or by ‘prices: low to high’ but NOT by best bargain? By best bargain, I mean the largest monetary differential between the retail cost and the selling price. If the <a href="https://www.forbes.com/sites/panosmourdoukoutas/2013/09/27/a-strategic-mistake-that-haunts-j-c-penney/#2f1cb698134c">failure of JCPenney’s ‘everyday low prices’ experiment</a> has taught us anything, is that people love a good deal; they love buying that supposedly $1000 jacket on sale for $500 (that’s 50% off) or that $100 shirt in the clearance bin for $10 (that’s 90% off). So it seems like being able to sort by best bargain would be a useful feature. And yet I have never seen an online shopping retailer with this sorting feature available. So since this sorting feature doesn’t exist, we as savvy programmers must take it upon ourselves to enhance our own online shopping experience and improve the efficiency of our bargain hunting!</p>

<p>In this blog post, I will demonstrate how to use <a href="https://github.com/hadley/rvest"><code class="highlighter-rouge">rvest</code></a>, a web-scraping tool in <code class="highlighter-rouge">R</code>, to find the best bargains on Poshmark.com. The code, of course, can be modified for other websites as well.</p>

<p>For demonstrative purposes, I will be shopping for women’s blazers. If I was browsing online, I would just visit the url <code class="highlighter-rouge">https://poshmark.com/category/Women-Jackets_&amp;_Coats-Blazers</code>. But now that we’re web scraping in R, I can use the <code class="highlighter-rouge">real_html()</code> function to get the source code corresponding to that page.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="s1">'rvest'</span><span class="p">)</span><span class="w">
</span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'https://poshmark.com/category/Women-Jackets_&amp;_Coats-Blazers'</span><span class="w">
</span><span class="n">webpage</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_html</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="http://localhost:4000/assets/blog/poshmark_pagesource.jpg" class="img-responsive" /></p>

<p>Upon inspecting the page source code, I notice that every product and all its associated information (original price, sale price, thumbnail image, and page link) is held within a div that is of class ‘col-x12’. So I will use the <code class="highlighter-rouge">html_nodes()</code> function and the ‘col-x12’ class to split up the webpage into 48 nodes, one for each product on the page.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">content</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="n">webpage</span><span class="p">,</span><span class="s1">'.col-x12'</span><span class="p">)</span><span class="w">
</span><span class="nf">length</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="c1"># double check 48 products</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>48
</code></pre></div></div>

<p>Now for each product, I will use a combination of the <code class="highlighter-rouge">html_nodes()</code> function and regex parsing to pull out specific information. For example, from inspecting the page source code, I can see that the sales price of each product is always in a div that is of class ‘price’ and between the substrings <code class="highlighter-rouge">&lt;div class=\"price\"&gt;</code> and <code class="highlighter-rouge">&lt;span class=\"original\"&gt;</code>. So I will use <code class="highlighter-rouge">gregexpr()</code> to specifically find the particular substring that meets these criteria. I will loop through each product to find its retail price, its sales price, the amount discounted (difference between the retail and sales price), the percent discounted, as well as an image and link to the product page.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">content</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">html_nodes</span><span class="p">(</span><span class="n">content</span><span class="p">[[</span><span class="n">i</span><span class="p">]],</span><span class="w"> </span><span class="s1">'.price'</span><span class="p">))</span><span class="w">
  </span><span class="n">ind1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="s1">'&lt;div class=\"price\"&gt;'</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nchar</span><span class="p">(</span><span class="s1">'&lt;div class=\"price\"&gt;'</span><span class="p">)</span><span class="w">
  </span><span class="n">ind2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="s1">'&lt;span class=\"original\"&gt;'</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
  </span><span class="n">ind3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ind2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nchar</span><span class="p">(</span><span class="s1">'&lt;span class=\"original\"&gt;'</span><span class="p">)</span><span class="w">
  </span><span class="n">ind4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;/span&gt;'</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
  </span><span class="n">selling</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">ind1</span><span class="m">+1</span><span class="p">,</span><span class="w"> </span><span class="n">ind2</span><span class="m">-2</span><span class="p">))</span><span class="w">
  </span><span class="n">original</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">ind3</span><span class="m">+1</span><span class="p">,</span><span class="w"> </span><span class="n">ind4</span><span class="m">-1</span><span class="p">))</span><span class="w">

  </span><span class="n">link</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">html_nodes</span><span class="p">(</span><span class="n">content</span><span class="p">[[</span><span class="n">i</span><span class="p">]],</span><span class="w"> </span><span class="s1">'.covershot-con'</span><span class="p">))</span><span class="w">
  </span><span class="n">ind1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="s1">'href='</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nchar</span><span class="p">(</span><span class="s1">'href='</span><span class="p">)</span><span class="w"> 
  </span><span class="n">ind2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="s1">'title'</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> 
  </span><span class="n">href</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s1">'https://poshmark.com'</span><span class="p">,</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">ind1</span><span class="m">+1</span><span class="p">,</span><span class="w"> </span><span class="n">ind2</span><span class="m">-3</span><span class="p">))</span><span class="w">

  </span><span class="n">ind1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="s1">'src='</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nchar</span><span class="p">(</span><span class="s1">'src='</span><span class="p">)</span><span class="w"> 
  </span><span class="n">ind2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gregexpr</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="s1">'.jpg'</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> 
  </span><span class="n">src</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">ind1</span><span class="m">+1</span><span class="p">,</span><span class="w"> </span><span class="n">ind2</span><span class="m">+3</span><span class="p">)</span><span class="w">

  </span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
	</span><span class="s1">'link'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">href</span><span class="p">,</span><span class="w"> 
	</span><span class="s1">'retail'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original</span><span class="p">,</span><span class="w"> 
	</span><span class="s1">'sale'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selling</span><span class="p">,</span><span class="w"> 
	</span><span class="s1">'discount'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original</span><span class="o">-</span><span class="n">selling</span><span class="p">,</span><span class="w"> 
	</span><span class="s1">'pct'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">original</span><span class="o">-</span><span class="n">selling</span><span class="p">)</span><span class="o">/</span><span class="n">original</span><span class="p">,</span><span class="w"> 
	</span><span class="s1">'image'</span><span class="o">=</span><span class="n">src</span><span class="w">
  </span><span class="p">)</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">

</span><span class="p">}))</span><span class="w"> 
</span></code></pre></div></div>

<p>Now, using this information, I can finally sort by best bargain! I can even further filter out products that I don’t want to consider such as products where the original value is unknown, or where the discount is not sufficiently large (in this case, less than $30 or less than 50% off). And this gives us a final set of products that we may be interested in!</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## sort</span><span class="w">
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">results</span><span class="o">$</span><span class="n">discount</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">

</span><span class="c1">## filter</span><span class="w">
</span><span class="c1">## retail price unknown</span><span class="w">
</span><span class="n">vi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="o">$</span><span class="n">retail</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="p">[</span><span class="o">!</span><span class="n">vi</span><span class="p">,]</span><span class="w">
</span><span class="c1">## no pictures</span><span class="w">
</span><span class="n">vi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="o">$</span><span class="n">image</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">''</span><span class="w">
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="p">[</span><span class="o">!</span><span class="n">vi</span><span class="p">,]</span><span class="w">
</span><span class="c1">## discount is not sufficient</span><span class="w">
</span><span class="n">vi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="o">$</span><span class="n">discount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">results</span><span class="o">$</span><span class="n">pct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.5</span><span class="w">
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="p">[</span><span class="o">!</span><span class="n">vi</span><span class="p">,]</span><span class="w">

</span><span class="n">head</span><span class="p">(</span><span class="n">results</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                                                                                      link
21                             https://poshmark.com/listing/Vintage-Wathne-Jacket-5c3aa18e409c15149a4863c0
19               https://poshmark.com/listing/Vintage-Wathne-Jacket-5c3aa18e409c15149a4863c0
35        https://poshmark.com/listing/Milly-Frayed-Edges-Double-Zip-Tweed-Blazer-5c3aa05bbaebf6bdb43d1bbd
27   https://poshmark.com/listing/St-John-red-Santana-knit-blazer-cardigan-Size-M-5c3aa155c9bf500d8976340a
30                    https://poshmark.com/listing/Eileen-Fisher-Loose-Fit-Blazer-5c3aa11e7386bc11a2f9ae76
33 https://poshmark.com/listing/Vintage-Bagatelle-100-Leather-Brown-Jacket-Blazer-5c3aa0c0df03076810f474bc
   retail sale discount       pct
21   1500  299     1201 0.8006667
19    600   45      555 0.9250000
35    598  150      448 0.7491639
27    500   80      420 0.8400000
30    250   40      210 0.8400000
33    198   30      168 0.8484848
</code></pre></div></div>

<p>I can just look at the resulting table, or I can further plot a thumbnail image of each product along with the amount that its discounted by to get a better sense of which products may be worth looking into further.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## plot</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">jpeg</span><span class="p">)</span><span class="w">
</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ceiling</span><span class="p">(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">mar</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">4</span><span class="p">))</span><span class="w">
</span><span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">results</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
  </span><span class="n">src</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">'image'</span><span class="p">])</span><span class="w">
  </span><span class="n">discount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">'discount'</span><span class="p">]</span><span class="w">
  </span><span class="n">download.file</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">'temp.jpg'</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'wb'</span><span class="p">)</span><span class="w">
  </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readJPEG</span><span class="p">(</span><span class="s2">"temp.jpg"</span><span class="p">,</span><span class="w"> </span><span class="n">native</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
  </span><span class="n">plot</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="o">:</span><span class="m">1</span><span class="p">,</span><span class="n">type</span><span class="o">=</span><span class="s2">"n"</span><span class="p">,</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">' : $'</span><span class="p">,</span><span class="w"> </span><span class="n">discount</span><span class="p">,</span><span class="w"> </span><span class="s1">' off'</span><span class="p">))</span><span class="w">
  </span><span class="n">rasterImage</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p><img src="http://localhost:4000/assets/blog/poshmark_results.jpg" class="img-responsive" /></p>

<p>And that’s how you can use <code class="highlighter-rouge">R</code> and <code class="highlighter-rouge">rvest</code> to do web scraping to find the best online shopping bargains! Hurray!</p>

<p>Ok, all joking aside, doing this in <code class="highlighter-rouge">R</code> may not be the most convenient solution since I have to bounce back and forth between my <code class="highlighter-rouge">R</code> terminal and my web browser (a Chrome extension would be better in that sense). But this is just to show how <code class="highlighter-rouge">R</code> and <code class="highlighter-rouge">rvest</code> can be used for web-scraping and how programming can be used for more than just data analysis.</p>

<p>For more creative coding, check out of some my other fun products:</p>
<ul>
  <li><a href="https://jef.works/art-with-code/">aRt with code</a> - generate custom art using R</li>
  <li><a href="https://custemized.org/">cuSTEMized</a> - generate personalized STEM storybooks</li>
</ul>

:ET