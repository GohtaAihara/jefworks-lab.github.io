I"2<h1 id="how-to-be-a-research-parasite-a-guide-to-analyzing-public-sequencing-data-from-geo">How to be a <a href="http://www.nejm.org/doi/full/10.1056/NEJMe1516564">“research parasite”</a>: a guide to analyzing public sequencing data from GEO</h1>

<p>In this tutorial, I will take you through my workflow for obtaining public sequencing data available on <a href="https://www.ncbi.nlm.nih.gov/geo/">NCBI GEO</a>.</p>

<p>Let’s say for example, I am interested in analyzing the single cell RNA-seq data found in this paper: <a href="http://www.cell.com/cell-stem-cell/abstract/S1934-5909(16)30343-5">Single-Cell Analysis Reveals a Close Relationship between Differentiating Dopamine and Subthalamic Nucleus Neuronal Lineages</a></p>

<p>In the paper, the authors note that “The accession number for the raw read sequence data, cell annotations, and RPKM and read count expression matrices for all cells reported in this paper is GEO: <code class="highlighter-rouge">GSE87069</code>.”</p>

<p>So let’s go to GEO and find this data! Here it is: <a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE87069"><code class="highlighter-rouge">http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE87069</code></a></p>

<p>If you just want the processed count matrices, you can just download them directly from the Supplementary file section and you’re done! However, if you’re like me, you want the raw read sequence data. Maybe you want to realign, maybe you want to look for alternative splicing, but whatever the reason, you will likely want to download them via command line instead of clicking over and over again through the Samples section, especially when there are hundreds of samples to click through.</p>

<p>To download the raw read sequence data, note the SRA number on GEO: <code class="highlighter-rouge">SRP090110</code></p>

<p>I like to just access the FTP directly. If you know the URL structure, it’s a simple plug and chug: <a href="ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByStudy/sra/SRP/SRP090/SRP090110"><code class="highlighter-rouge">ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByStudy/sra/SRP/SRP090/SRP090110</code></a></p>

<p>Now, you see a bunch of folders containing <code class="highlighter-rouge">.sra</code> files! We just have to download them all, convert them to .fastq, and start our realignment, requantification, and reanalysis as needed. For downloading, you can write a simple bash script to loop over the folders, but I prefer to use <a href="http://asperasoft.com/">Aspera</a>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># copy to your current directory</span><span class="w">
</span><span class="n">ascp</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">asperaweb_id_dsa.openssh</span><span class="w"> </span><span class="o">-</span><span class="n">Q</span><span class="w"> </span><span class="o">-</span><span class="nb">T</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="n">anonftp</span><span class="o">@</span><span class="n">ftp</span><span class="o">-</span><span class="n">trace.ncbi.nlm.nih.gov</span><span class="o">:/</span><span class="n">sra</span><span class="o">/</span><span class="n">sra</span><span class="o">-</span><span class="n">instant</span><span class="o">/</span><span class="n">reads</span><span class="o">/</span><span class="n">ByStudy</span><span class="o">/</span><span class="n">sra</span><span class="o">/</span><span class="n">SRP</span><span class="o">/</span><span class="n">SRP090</span><span class="o">/</span><span class="n">SRP090110</span><span class="w"> </span><span class="n">.</span><span class="w">
</span></code></pre></div></div>

<p>(Of course, this means you’ll need to have Aspera installed and the licenses needed to use it. If you are on Harvard Orchestra for example, <a href="https://wiki.med.harvard.edu/Orchestra/AsperaToDownloadNcbiSraData">here is a tutorial for installing, setting up the software license, setting up the path, and so forth</a>)</p>

<p>Now you have a bunch of SRA files named with their SRR run name (ex. SRR4255367.sra). How do you get back the sample name that’s often used in GEO to provide metainformation and other annotations?! For that, you will need to use the SRA Run Selector. Again, once you know the URL structure, it’s a simple plug and chug: <a href="http://www.ncbi.nlm.nih.gov/Traces/study/?acc=SRP090110"><code class="highlighter-rouge">http://www.ncbi.nlm.nih.gov/Traces/study/?acc=SRP090110</code></a>. You can just download the RunInfo Table as a spreadsheet so you can later map from Run name to Sample name as needed.</p>

<p>Then, to convert .sra files to .fastq files, you can use <a href="https://github.com/ncbi/sra-tools">SRA toolkit</a>. I actually like to wrap everything up into a <a href="https://snakemake.readthedocs.io/en/stable/">snakemake</a> Python make file to handle job submission.  I can just run the following lines on command line:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">seq</span><span class="o">/</span><span class="n">sratoolkit</span><span class="o">/</span><span class="m">2.5.2</span><span class="w">
</span><span class="n">snakemake</span><span class="w"> </span><span class="o">--</span><span class="n">snakefile</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jf154</span><span class="o">/</span><span class="n">snakepit</span><span class="o">/</span><span class="n">sra</span><span class="o">/</span><span class="n">sra.snakefile</span><span class="w"> </span><span class="o">--</span><span class="n">jobs</span><span class="w"> </span><span class="m">999</span><span class="w"> </span><span class="o">--</span><span class="n">cluster</span><span class="w"> </span><span class="s1">'bsub -q short -W 12:00 -R "rusage[mem=4000]"'</span><span class="w">
</span><span class="n">mv</span><span class="w"> </span><span class="o">*</span><span class="n">.fastq.gz</span><span class="w"> </span><span class="n">fastq</span><span class="o">/</span><span class="w">
</span><span class="n">mv</span><span class="w"> </span><span class="o">*</span><span class="n">.log</span><span class="w"> </span><span class="n">out</span><span class="o">/</span><span class="w">
</span></code></pre></div></div>

<p>Where <code class="highlighter-rouge">/home/jf154/snakepit/sra/sra.snakefile</code> is:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sra.snakefile</span><span class="w">
</span><span class="c1"># @author: Jean Fan</span><span class="w">
</span><span class="c1"># @date: May 16, 2016</span><span class="w">
</span><span class="c1"># @desc: From SRA to Fastq</span><span class="w">
</span><span class="c1">#</span><span class="w">
</span><span class="c1"># Usage: snakemake --snakefile /home/jf154/snakepit/sra/sra.snakefile --jobs 999 --cluster 'bsub -q short -W 12:00 -R "rusage[mem=4000]"'</span><span class="w">

</span><span class="n">from</span><span class="w"> </span><span class="n">os.path</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">join</span><span class="w">

</span><span class="c1"># Globals ---------------------------------------------------------------------</span><span class="w">

</span><span class="c1"># Full path to Bowtie2 index.</span><span class="w">
</span><span class="n">INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/groups/shared_databases/igenome/Homo_sapiens/UCSC/hg19/Sequence/Bowtie2Index/genome"</span><span class="w">

</span><span class="c1"># Full path to gene model annotations for splice aware alignment.</span><span class="w">
</span><span class="n">GTF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/groups/shared_databases/igenome/Homo_sapiens/UCSC/hg19/Annotation/Genes/genes.gtf"</span><span class="w">

</span><span class="c1"># Full path to a folder that holds all of your sra files</span><span class="w">
</span><span class="n">SRA_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sra/"</span><span class="w">

</span><span class="c1"># A snakemake regular expression matching sra files</span><span class="w">
</span><span class="n">SAMPLES</span><span class="p">,</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glob_wildcards</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">SRA_DIR</span><span class="p">,</span><span class="w"> </span><span class="s1">'{sample,[^/]+}.sra'</span><span class="p">))</span><span class="w">

</span><span class="c1"># Make sure all modules are loaded</span><span class="w">
</span><span class="c1"># ex. module load seq/sratoolkit/2.5.2</span><span class="w">

</span><span class="c1"># Rules -----------------------------------------------------------------------</span><span class="w">

</span><span class="n">rule</span><span class="w"> </span><span class="n">all</span><span class="o">:</span><span class="w">
    </span><span class="n">input</span><span class="o">:</span><span class="w">
        </span><span class="n">expand</span><span class="p">(</span><span class="s1">'{sample}.sra2fastqgz.log'</span><span class="p">,</span><span class="w"> </span><span class="n">sample</span><span class="o">=</span><span class="n">SAMPLES</span><span class="p">)</span><span class="w">

</span><span class="n">rule</span><span class="w"> </span><span class="n">sra2fastq</span><span class="o">:</span><span class="w">
     </span><span class="n">input</span><span class="o">:</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="n">SRA_DIR</span><span class="p">,</span><span class="w"> </span><span class="s1">'{sample}.sra'</span><span class="p">)</span><span class="w">
     </span><span class="n">output</span><span class="o">:</span><span class="w">
        </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'{sample}.sra2fastq.log'</span><span class="p">,</span><span class="w">
        </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'{sample}_1.fastq'</span><span class="p">,</span><span class="w">
        </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'{sample}_2.fastq'</span><span class="p">,</span><span class="w">
     </span><span class="n">shell</span><span class="o">:</span><span class="w"> </span><span class="s1">'fastq-dump --split-files {input}; echo {input} &gt; {output.log}'</span><span class="w">

</span><span class="n">rule</span><span class="w"> </span><span class="n">bgzipfastq</span><span class="o">:</span><span class="w">
    </span><span class="n">input</span><span class="o">:</span><span class="w">
        </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rules.sra2fastq.output.r1</span><span class="p">,</span><span class="w">
        </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rules.sra2fastq.output.r2</span><span class="w">
    </span><span class="n">output</span><span class="o">:</span><span class="w"> </span><span class="s1">'{sample}.sra2fastqgz.log'</span><span class="p">,</span><span class="w">
    </span><span class="n">shell</span><span class="o">:</span><span class="w"> </span><span class="s1">'/opt/htslib-1.2.1/bin/bgzip {input.r1}; /opt/htslib-1.2.1/bin/bgzip {input.r2}; echo {input} &gt; {output}'</span><span class="w">
</span></code></pre></div></div>
<p>This snakemake file has been design for paired-end RNA-seq and will convert each .sra into two .fastq files and then bgzips them. I have additional snakemake files for aligning, calling variants, quantifying to counts, looking for alternative splicing, and so forth. For more information about snakemake, check out this <a href="http://slowkow.com/notes/snakemake-tutorial/">tutorial</a>. But once you have .fastq files, you’re ready to process, reanalyze, and be the best research parasite you can be!</p>
:ET